<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Turnos Pilates Reformer</title>
    <style>
      :root {
        --body-bg-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --container-bg: white;
        --container-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        --header-bg: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --header-text: white;
        --controls-bg: #f8f9fa;
        --controls-border: #e9ecef;
        --text-color-default: #333;
        --btn-bg: #6c757d;
        --btn-text: white;
        --btn-active-day-bg: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        --btn-active-timeslot-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --current-selection-bg: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        --current-selection-text: white;
        --table-bg: white;
        --table-border: #dee2e6;
        --th-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --th-text: white;
        --td-bg: #f8f9fa;
        --td-hover-bg: #e3f2fd;
        --time-column-bg: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --time-column-text: white;
        --student-name-text: #2c3e50;
        --student-name-clickable-text: #007bff;
        --student-name-clickable-hover-text: #0056b3;
        --empty-cell-text: #6c757d;
        --modal-content-bg: #fefefe;
        --modal-text: #333;
        --input-editing-bg: #fff3cd;
        --input-editing-border: #007bff;
        --input-editing-text: #333;
        --stats-bg: #e9ecef;
        --stats-header-text: #495057;
        --stat-item-bg: white;
        --stat-item-text: #495057;
        --export-section-bg: #f8f9fa;
        --export-section-border: #e9ecef;
        --bed-header-bg: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        --export-btn-bg: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        --edit-btn-edit-bg: #28a745;
        --edit-btn-save-bg: #007bff;
        --edit-btn-cancel-bg: #dc3545;
        --edit-btn-text: white;
        --theme-toggle-btn-bg: #555;
        --theme-toggle-btn-text: white;
        --theme-toggle-btn-hover-bg: #777;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--body-bg-color);
        min-height: 100vh;
        padding: 20px;
        color: var(--text-color-default);
      }

      body.dark-mode {
        --body-bg-color: linear-gradient(135deg, #2c3e50 0%, #4a6a8a 100%);
        --container-bg: #2d3748;
        --container-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        --header-bg: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        --header-text: #e2e8f0;
        --controls-bg: #1a202c;
        --controls-border: #4a5568;
        --text-color-default: #e2e8f0;
        --btn-bg: #4a5568;
        --btn-text: #e2e8f0;
        --btn-active-day-bg: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        --btn-active-timeslot-bg: linear-gradient(135deg, #4c51bf 0%, #6b46c1 100%);
        --current-selection-bg: linear-gradient(135deg, #2f855a 0%, #276749 100%);
        --current-selection-text: #e2e8f0;
        --table-bg: #2d3748;
        --table-border: #4a5568;
        --th-bg: linear-gradient(135deg, #3b4a6b 0%, #4a6a8a 100%);
        --th-text: #e2e8f0;
        --td-bg: #1a202c;
        --td-hover-bg: #2c3e50;
        --time-column-bg: linear-gradient(135deg, #2b6cb0 0%, #2c5282 100%);
        --time-column-text: #e2e8f0;
        --student-name-text: #cbd5e0;
        --student-name-clickable-text: #63b3ed;
        --student-name-clickable-hover-text: #90cdf4;
        --empty-cell-text: #a0aec0;
        --modal-content-bg: #2d3748;
        --modal-text: #e2e8f0;
        --input-editing-bg: #4a5568;
        --input-editing-border: #63b3ed;
        --input-editing-text: #e2e8f0;
        --stats-bg: #1a202c;
        --stats-header-text: #a0aec0;
        --stat-item-bg: #2d3748;
        --stat-item-text: #cbd5e0;
        --export-section-bg: #1a202c;
        --export-section-border: #4a5568;
        --bed-header-bg: linear-gradient(135deg, #c53030 0%, #9b2c2c 100%);
        --export-btn-bg: linear-gradient(135deg, #2f855a 0%, #276749 100%);
        --edit-btn-edit-bg: #2f855a;
        --edit-btn-save-bg: #3182ce;
        --edit-btn-cancel-bg: #c53030;
        --edit-btn-text: #e2e8f0;
        --theme-toggle-btn-bg: #bbb;
        --theme-toggle-btn-text: #333;
        --theme-toggle-btn-hover-bg: #ddd;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        background: var(--container-bg);
        border-radius: 15px;
        box-shadow: var(--container-shadow);
        overflow: hidden;
      }

      .header {
        background: var(--header-bg);
        color: var(--header-text);
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .controls {
        background: var(--controls-bg);
        padding: 20px;
        border-bottom: 2px solid var(--controls-border);
      }

      .day-selector {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 15px;
      }

      .time-slot-selector {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20px;
      }

      .day-btn,
      .time-slot-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        background: var(--btn-bg);
        color: var(--btn-text);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        font-size: 14px;
      }

      .day-btn:hover,
      .time-slot-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .day-btn.active {
        background: var(--btn-active-day-bg);
      }

      .time-slot-btn.active {
        background: var(--btn-active-timeslot-bg);
      }

      .current-selection {
        text-align: center;
        margin: 15px 0;
        padding: 10px;
        background: var(--current-selection-bg);
        color: var(--current-selection-text);
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.2em;
      }

      .edit-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .edit-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .edit-btn.edit {
        background: var(--edit-btn-edit-bg);
        color: var(--edit-btn-text);
      }

      .edit-btn.save {
        background: var(--edit-btn-save-bg);
        color: var(--edit-btn-text);
      }

      .edit-btn.cancel {
        background: var(--edit-btn-cancel-bg);
        color: var(--edit-btn-text);
      }
      
      .edit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .schedule-grid {
        padding: 20px;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--table-bg);
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        min-width: 800px;
        border: 2px solid var(--table-border);
      }

      th,
      td {
        padding: 15px 10px;
        text-align: center;
        border: 2px solid var(--table-border);
        position: relative;
        vertical-align: middle;
      }

      th {
        background: var(--th-bg);
        color: var(--th-text);
        font-weight: bold;
        font-size: 1.1em;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      }

      td {
        background: #f8f9fa;
        background: var(--td-bg);
        color: var(--student-name-text);
        transition: all 0.3s ease;
        min-height: 60px;
        height: 60px;
      }

      td:hover {
        background: var(--td-hover-bg);
        transform: scale(1.02);
      }

      .time-column {
        background: var(--time-column-bg) !important;
        color: var(--time-column-text);
        font-weight: bold;
        font-size: 1.2em;
        width: 120px;
      }

      .student-cell {
        cursor: pointer;
        position: relative;
        font-weight: 500;
        font-size: 14px;
      }

      .student-cell.editing input {
        width: 100%;
        border: 2px solid var(--input-editing-border);
        background: var(--input-editing-bg);
        color: var(--input-editing-text);
        padding: 8px;
        border-radius: 5px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;        
      }

      .student-info-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }

      .attendance-check {
        margin-right: 5px;
        cursor: pointer;
        width: 18px;
        height: 18px;
      }

      .student-name-clickable {
        cursor: pointer;
        text-decoration: underline;
        color: var(--student-name-clickable-text);
      }
      .student-name-clickable:hover {
        color: var(--student-name-clickable-hover-text);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
      }
      .modal-content {
        background-color: var(--modal-content-bg);
        color: var(--modal-text);
        margin: 15% auto;
        padding: 25px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);        
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      body.dark-mode .close-button {
        color: #ccc;
      }
      body.dark-mode .close-button:hover,
      body.dark-mode .close-button:focus {
        color: #fff;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      #modalStudentNotes {
        width: 100%;
        margin-top: 5px;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid var(--table-border);
        background-color: var(--td-bg);
        color: var(--modal-text);
      }

      .empty-cell {
        color: var(--empty-cell-text);
        font-style: italic;
        opacity: 0.7;
      }

      .bed-header {
        background: var(--bed-header-bg) !important;
        width: 150px;
      }

      .student-name {
        display: block;
        font-weight: bold;
        color: var(--student-name-text);
        line-height: 1.3;
        word-break: break-word;
      }

      .export-section {
        background: var(--export-section-bg);
        padding: 20px;
        border-top: 2px solid var(--export-section-border);
        text-align: center;
      }

      .export-btn {
        padding: 12px 30px;
        background: var(--export-btn-bg);
        color: var(--btn-text); /* Assuming export buttons share text color with general buttons */
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        margin: 0 10px;
      }

      .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .stats {
        background: var(--stats-bg);
        padding: 15px;
        margin: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .stats h3 {
        color: var(--stats-header-text);
        margin-bottom: 10px;
      }

      .stat-item {
        display: inline-block;
        margin: 0 15px;
        padding: 8px 15px;
        background: var(--stat-item-bg);
        border-radius: 15px;
        font-weight: bold;
        color: var(--stat-item-text);
      }

      #themeToggleBtn {
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        background: var(--theme-toggle-btn-bg);
        color: var(--theme-toggle-btn-text);
        margin-left: 10px;
      }
      #themeToggleBtn:hover {
        background: var(--theme-toggle-btn-hover-bg);
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
          border-radius: 10px;
        }

        .header h1 {
          font-size: 1.8em;
        }

        th,
        td {
          padding: 8px 4px;
          font-size: 0.9em;
        }

        .day-btn,
        .time-slot-btn {
          padding: 8px 16px;
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üßò‚Äç‚ôÄÔ∏è Turnos Pilates Reformer</h1>
        <button id="themeToggleBtn" onclick="toggleTheme()">üåì Alternar Tema</button>
        <p>Sistema de horarios por horas - 6 camas disponibles</p>
      </div>

      <div class="controls">
        <div class="day-selector">
          <button class="day-btn active" onclick="showDay('lunes')">
            Lunes
          </button>
          <button class="day-btn" onclick="showDay('martes')">Martes</button>
          <button class="day-btn" onclick="showDay('miercoles')">
            Mi√©rcoles
          </button>
          <button class="day-btn" onclick="showDay('jueves')">Jueves</button>
          <button class="day-btn" onclick="showDay('viernes')">Viernes</button>
        </div>

        <div class="time-slot-selector">
          <button
            class="time-slot-btn active"
            onclick="showTimeSlot('morning_afternoon_combined')"
          >
            üåÖ Ma√±ana y Tarde (08:00-15:00)
          </button>
          <button class="time-slot-btn" onclick="showTimeSlot('evening_combined')">
            üåô Tarde y Noche (16:00-21:00)
          </button>
        </div>

        <div class="current-selection" id="currentSelection">
          üìÖ Lunes - üåÖ Ma√±ana (8:00-12:00)
        </div>

        <div class="edit-controls">
          <button class="edit-btn edit" onclick="toggleEdit()">
            ‚úèÔ∏è Editar Horarios
          </button>
          <button
            class="edit-btn save"
            onclick="saveChanges()"
            style="display: none"
          >
            üíæ Guardar Cambios
          </button>
          <button
            class="edit-btn cancel"
            onclick="cancelEdit()"
            style="display: none"
          >
            ‚ùå Cancelar
          </button>
          <button class="edit-btn" onclick="clearCurrentSchedule()">
            üóëÔ∏è Limpiar Turno
          </button>
          <button class="edit-btn" onclick="copySchedule()">
            üìã Copiar Turno
          </button>
        </div>
      </div>

      <div class="stats" id="statsSection">
        <!-- Las estad√≠sticas se generar√°n din√°micamente -->
      </div>

      <div class="schedule-grid">
        <table id="scheduleTable">
          <!-- La tabla se generar√° din√°micamente -->
        </table>
      </div>

      <div class="export-section">
        <button class="export-btn" onclick="exportToJSON()">
          üì• Exportar Datos (JSON)
        </button>
        <input
          type="file"
          id="importFile"
          accept=".json"
          style="display: none"
          onchange="importFromJSON()"
        />
        <button
          class="export-btn"
          onclick="document.getElementById('importFile').click()"
        >
          üì§ Importar Datos
        </button>
        <button class="export-btn" onclick="printSchedule()">
          üñ®Ô∏è Imprimir Horario
        </button>
      </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeStudentModal()">&times;</span>
        <h2 id="modalStudentName">Detalles del Alumno</h2>
        <p><strong>Profesor/a:</strong> <span id="modalProfessorName"></span></p>
        <p><strong>Asistencia:</strong> <span id="modalAttendanceStatus"></span></p>
        <label for="modalStudentNotes" style="display: block; margin-bottom: 5px;"><strong>Notas:</strong></label>
        <textarea id="modalStudentNotes" rows="3"></textarea>
        <button onclick="saveStudentNotes()" style="margin-top: 10px; padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Guardar Notas</button>
      </div>
    </div>

    <script>
      // Datos de horarios organizados por d√≠a y turno
      let scheduleData = {
        "lunes": {
          "morning": {
            "08:00 - 09:00": ["Florencia Ayala", "Claudia Bogarin", "Avelino", "Noelia", "Andrea", "Bianca"],
            "09:00 - 10:00": ["Roxana Serra", "Claudia P", "Nora", "Carina F", "Patricia S", "Blanca"],
            "10:00 - 11:00": ["Marta Lamuzzo", "Daniel", "Juan Carlos", "Silvia Amador", "Romina", "Cristina"],
            "11:00 - 12:00": ["Silvia Juarez", "Yesica", "Florencia Cerbetto", "Morena Alonzo", "Ver√≥nica", "Lucia"]
          },
          "afternoon": {
            "14:00 - 15:00": ["Alejandra", "Cecilia", "Abigail", "Adriana", "Adriana", "Gabriela"]
          },
          "evening": {
            "16:00 - 17:00": ["Marcela Frutos", "Erika", "Elisabet", "Mariana P", "Adriana", "Silvia"],
            "17:00 - 18:00": ["Fabiana", "Laura Jambin", "Maria del Rosario", "Karina", "Belen", "Julieta"],
            "18:00 - 19:00": ["", "Lesley", "Graciela Valdez", "Gerldine", "Marcela", "Mariana Cecilia"],
            "19:00 - 20:00": ["Carolina T", "Patricia", "Ester Moreno", "Victoria", "Assencion Camila", "Virginia"],
            "20:00 - 21:00": ["Denis", "Claudia", "Alejandra R", "Liliana", "Veronica Ochoa", "Veronica"]
          }
        },
        "martes": {
          "morning": {
            "08:00 - 09:00": ["Marcia Monjes", "Alicia Aracha", "Paula", "Florencia Alvarez", "Micaela", "Noelia"],
            "09:00 - 10:00": ["Marisa Olmedo", "Patricia V", "Daniela", "Pamela", "Marcia", "Analia O."],
            "10:00 - 11:00": ["Nilda Ibarra", "Judith", "Karla", "Ana", "Andrea", "Lucia"],
            "11:00 - 12:00": ["Fanny", "Begonia", "Sara", "Silvana", "Monica Molinaro", "Agostina"]
          },
          "afternoon": {
            "14:00 - 15:00": ["Alicia Casella", "Alicia Hidalgo", "Viviana", "M√≥nica", "Iris Alejandra", "Irene"]
          },
          "evening": {
            "16:00 - 17:00": ["Patricia", "Mart√≠n", "Sof√≠a", "Cristina T", "Ariel Tejerina", "Adriana"],
            "17:00 - 18:00": ["Micaela", "Carolina", "Graciela Ruchi", "Gabriela", "Pilar Palazo", "Mama de Pilar"],
            "18:00 - 19:00": ["Marcela Perez", "Carlos", "Adriana", "Carlos", "Valeria", "Maria Eugenia Melli"],
            "19:00 - 20:00": ["Monica Rinaldi", "Mirta Rinaldi", "Maria Rosa", "Ana Maria", "Silvina H Abril", ""],
            "20:00 - 21:00": ["Herminia", "Paiu", "Sergio", "Natacha", "Emma", "Giuliana"]
          }
        },
        "miercoles": {
          "morning": {
            "08:00 - 09:00": ["Florencia", "Claudia", "Avelino", "Noelia", "Andrea", ""],
            "09:00 - 10:00": ["Roxana S", "Claudia P", "Nora", "Carina F", "Patricia S", "Graciela C"],
            "10:00 - 11:00": ["Gabriela F", "Marisa Robledo", "Claudia", "Jesica", "Romina", "Cristina"],
            "11:00 - 12:00": ["Adriana", "Isabel", "Edith", "Mirta", "Belqui", "Blanca"]
          },
          "afternoon": {
            "14:00 - 15:00": ["Alejandra", "Cecilia", "Abigail", "Adriana", "Adriana", "Nilda"]
          },
          "evening": {
            "16:00 - 17:00": ["Patricia", "Mart√≠n", "Sof√≠a", "Cristina T", "Morena A", "Veronica"],
            "17:00 - 18:00": ["Fabiana Julieta", "Laura Jambrino", "Maria del Rosario", "Karina", "Belen", "Clari"],
            "18:00 - 19:00": ["Mariana Cecilia", "Lezley", "Graciela Valdez", "Gerldine", "Natalia", "Aldana"],
            "19:00 - 20:00": ["Carolina T", "Patricia", "Ester Moreno", "Victoria", "Assencion Camila", "Bianca"],
            "20:00 - 21:00": ["Denis", "Claudia", "Alejandra R", "Liliana", "Veronica Ochoa", "Veronica"]
          }
        },
        "jueves": {
          "morning": {
            "08:00 - 09:00": ["Marcia Monjes", "Alicia Aracha", "", "Florencia Alvarez", "Micaela", "Bianca"],
            "09:00 - 10:00": ["Marisa O", "Patricia Viola", "Daniela", "Pamela", "Lucia", "Lucia Mariosini"],
            "10:00 - 11:00": ["Marta Lamuzzo", "Daniel Pelado Flaco", "Juan Carlos", "Silvia Amador", "Judith", "Ana"],
            "11:00 - 12:00": ["Silvia Juarez", "Jesica", "Florencia Cerbetto", "Silvana Rinaldi", "Monica M", "Fanny"]
          },
          "afternoon": {
            "14:00 - 15:00": ["Alicia", "Alicia Hidalgo", "Viviana", "M√≥nica", "Iris Alejandra", "Irene"]
          },
          "evening": {
            "16:00 - 17:00": ["Marcela Frutos", "Erika", "Elisabet", "Mariana P", "Adriana", "Silvia"],
            "17:00 - 18:00": ["", "", "", "", "", ""],
            "18:00 - 19:00": ["Marcela Perez", "Carlos", "Adriana", "Carlos", "Marcela", "Geaciela Ruchi"],
            "19:00 - 20:00": ["Monica Rinaldi", "Mirta Rinaldi", "Maria Rosa", "Ana Maria", "Silvina H Abril", ""],
            "20:00 - 21:00": ["Herminia", "Paiu", "Sergio", "Natacha", "Emma", "Eliana"]
          }
        },
        "viernes": {
          "morning": {
            "08:00 - 09:00": ["Florencia", "Gabriela", "Avelino Claudio", "Noelia", "Analia O", "Silvia F"],
            "09:00 - 10:00": ["Roxana Serra", "Claudia P", "Nora", "Carina F", "Maria", "Graciela C"],
            "10:00 - 11:00": ["Nilda Ibarra", "Marisa Robledo", "Karla", "Claudia", "Romina", "Blanca"],
            "11:00 - 12:00": ["Adriana", "Isabel", "Edith", "Mirta", "Belqui", "Begonia"]
          },
          "afternoon": {
            "14:00 - 15:00": ["", "", "", "", "", ""]
          },
          "evening": {
            "16:00 - 17:00": ["Patricia", "Mart√≠n", "Sof√≠a", "Cristina T", "Morena A", "Veronica"],
            "17:00 - 18:00": ["Micaela", "Carolina", "Elisabet", "Maria del Rosario", "Mariana Cecilia", "Clari"],
            "18:00 - 19:00": ["Julieta", "Lesley Belen", "Bianca", "Aldana", "Valeria", "Maria Eugenia Melli"],
            "19:00 - 20:00": ["Carolina T", "Patricia", "Ariel Tejerina", "Cecilia", "Juampi", "Virginia"],
            "20:00 - 21:00": ["Denis", "Claudia", "Alejandra R", "Liliana", "Lucia", "Giuliana"]
          }
        }
      };

      let currentDay = "lunes";
      let currentTimeSlot = "morning_afternoon_combined"; // Updated initial value
      let isEditing = false;
      let originalData = {};
      let copiedSchedule = null;
      let currentModalInfo = {}; // To store info for saving notes in modal

      // --- Persistencia y Tema ---
      function saveScheduleToLocalStorage() {
        localStorage.setItem('pilatesScheduleData', JSON.stringify(scheduleData));
        console.log("Horario guardado en LocalStorage.");
      }

      function loadScheduleFromLocalStorage() {
        const savedData = localStorage.getItem('pilatesScheduleData');
        if (savedData) {
          try {
            scheduleData = JSON.parse(savedData);
            console.log("Horario cargado desde LocalStorage.");
          } catch (e) {
            console.error("Error al parsear datos de LocalStorage:", e);
          }
        }
      }
      // Helper function to transform old data structure to new one
      function transformScheduleData(data) {
        const newData = {};
        for (const day in data) {
          newData[day] = {};
          for (const category in data[day]) {
            newData[day][category] = {};
            for (const timeSlot in data[day][category]) {
              const studentsArray = data[day][category][timeSlot];
              newData[day][category][timeSlot] = { // Ensure this structure matches everywhere
                professor: "Prof. Asignado", // Default professor
                students: studentsArray.map(studentName => ({
                  name: studentName || "",
                  attended: false,
                  notes: ""
                }))
              };
            }
          }
        }
        return newData;
      }

      // Check if scheduleData needs transformation (e.g. if it's in the old format)
      // This is a simple check; more robust checks might be needed for varied old formats.
      function isOldFormat(data) {
        for (const day in data) {
          for (const category in data[day]) {
            for (const timeSlot in data[day][category]) {
              // If a time slot directly contains an array, it's likely the old format.
              if (Array.isArray(data[day][category][timeSlot])) {
                return true;
              }
              return false; // Found a new format item, assume all is new.
            }
          }
        }
        return false; // Default to false if data is empty or structure is unexpected
      }

      function getCategoryForTime(timeString) {
        const startHour = parseInt(timeString.split(':')[0]);
        if (startHour >= 8 && startHour < 12) return 'morning';
        if (startHour >= 12 && startHour < 16) return 'afternoon'; // Original afternoon range (12-16)
        if (startHour >= 16 && startHour < 22) return 'evening';   // Original evening range (16-22)
        return null; 
      }

      // Generar horarios por horas
      function generateTimeSlots(start, end) {
        const slots = [];
        for (let hour = start; hour < end; hour++) {
          const from = hour.toString().padStart(2, "0") + ":00";
          const to = (hour + 1).toString().padStart(2, "0") + ":00";
          slots.push(`${from} - ${to}`);
        }
        return slots;
      }

      // Obtener horarios por turno
      function getTimeSlotsForPeriod(period) {
        switch (period) {
          case "morning_afternoon_combined":
            return generateTimeSlots(8, 12).concat(generateTimeSlots(14, 15)); // 08-12 and 14-15
          case "evening_combined":
            return generateTimeSlots(16, 21); // 16-21
          default:
            return [];
        }
      }

      // Crear tabla
      function createTable() {
        const table = document.getElementById("scheduleTable");
        const timeSlots = getTimeSlotsForPeriod(currentTimeSlot);

        // Limpiar tabla
        table.innerHTML = "";

        // Crear encabezados
        const headerRow = table.insertRow();
        headerRow.insertCell().innerHTML = "<strong>Horario</strong>";
        for (let i = 1; i <= 6; i++) {
          const cell = headerRow.insertCell();
          cell.innerHTML = `<strong>Cama ${i}</strong>`;
          cell.className = "bed-header";
        }

        // Crear filas de horarios
        timeSlots.forEach((time) => {
          const row = table.insertRow();
          const timeCell = row.insertCell();
          timeCell.className = "time-column";
          
          const category = getCategoryForTime(time);
          const currentProfessor = scheduleData[currentDay]?.[category]?.[time]?.professor || "Prof. Asignado";

          if (isEditing) {
            timeCell.innerHTML = `
              <div><strong>${time}</strong></div>
              <div style="margin-top: 5px;">
                <input type="text" 
                       value="${currentProfessor}" 
                       onchange="updateProfessor('${time}', this.value)" 
                       placeholder="Profesora" 
                       style="width: 90%; font-size: 0.9em; padding: 3px; border-radius:3px; border:1px solid var(--input-editing-border); background:var(--input-editing-bg); color:var(--input-editing-text);">
              </div>
            `;
          } else {
            timeCell.innerHTML = `<strong>${time}</strong><br><small style="font-weight:normal; font-size:0.9em;">Prof: ${currentProfessor}</small>`;
          }

          for (let bed = 1; bed <= 6; bed++) {
            const cell = row.insertCell();
            // const category = getCategoryForTime(time); // Category already defined above

            const slotData = scheduleData[currentDay]?.[category]?.[time];
            const studentData = slotData?.students?.[bed - 1] || { name: "", attended: false, notes: "" };
            const studentName = studentData.name || ""; // Ensure studentName is not undefined
            const studentAttended = studentData.attended;

            if (isEditing) {
              cell.innerHTML = `<input type="text" value="${studentName}" onchange="updateCell('${time}', ${
                bed - 1
              }, this.value)" placeholder="Nombre del alumno">`;
              cell.className = "student-cell editing";
            } else {
              if (studentName) {
                const checkboxId = `att-${currentDay}-${category}-${time.replace(/[\s:-]/g, '')}-${bed-1}`;
                cell.innerHTML = `
                  <div class="student-info-container">
                    <input type="checkbox" 
                           class="attendance-check" 
                           id="${checkboxId}"
                           ${studentAttended ? "checked" : ""} 
                           onchange="updateAttendance('${currentDay}', '${category}', '${time}', ${bed - 1}, this.checked)">
                    <span class="student-name-clickable" onclick="openStudentModal('${currentDay}', '${category}', '${time}', ${bed - 1})">${studentName}</span>
                  </div>`;
              } else {
                cell.innerHTML = '<span class="empty-cell">Disponible</span>';
              }
              cell.className = "student-cell";
            }
          }
        });
        updateStats();
      }

      // Actualizar profesor
      function updateProfessor(time, newName) {
        const category = getCategoryForTime(time);
        if (!scheduleData[currentDay]) scheduleData[currentDay] = {};
        if (!scheduleData[currentDay][category]) scheduleData[currentDay][category] = {};

        if (!scheduleData[currentDay][category][time]) {
            scheduleData[currentDay][category][time] = {
                professor: newName.trim(),
                students: Array(6).fill(null).map(() => ({ name: "", attended: false, notes: "" }))
            };
        } else {
            scheduleData[currentDay][category][time].professor = newName.trim();
        }
        // No redraw needed here, changes will be saved with saveChanges()
      }

      // Actualizar celda
      function updateCell(time, bedIndex, value) {
        const category = getCategoryForTime(time);
        if (!scheduleData[currentDay][category]) scheduleData[currentDay][category] = {};
        if (!scheduleData[currentDay][category][time]) {
            scheduleData[currentDay][category][time] = {
                professor: "Prof. Asignado",
                students: Array(6).fill(null).map(() => ({ name: "", attended: false, notes: ""})),
            };
        } else if (!scheduleData[currentDay][category][time].students) {
             scheduleData[currentDay][category][time].students = Array(6).fill(null).map(() => ({ name: "", attended: false, notes: "" }));
        }
         if (!scheduleData[currentDay][category][time].students[bedIndex]) {
            scheduleData[currentDay][category][time].students[bedIndex] = { name: "", attended: false, notes: "" };
        }
        scheduleData[currentDay][category][time].students[bedIndex].name = value.trim();
      }

      // Cambiar d√≠a
      function showDay(day) {
        currentDay = day;

        // Actualizar botones de d√≠a
        document.querySelectorAll(".day-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        updateCurrentSelection();
        createTable();
      }

      // Cambiar turno
      function showTimeSlot(timeSlot) {
        currentTimeSlot = timeSlot;

        // Actualizar botones de turno
        document.querySelectorAll(".time-slot-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        updateCurrentSelection();
        createTable();
      }

      // Actualizar selecci√≥n actual
      function updateCurrentSelection() {
        const dayNames = {
          lunes: "Lunes",
          martes: "Martes",
          miercoles: "Mi√©rcoles",
          jueves: "Jueves",
          viernes: "Viernes",
        };

        const timeNames = {
          morning_afternoon_combined: "üåÖ Ma√±ana y Tarde (08:00-15:00)",
          evening_combined: "üåô Tarde y Noche (16:00-21:00)",
        };

        document.getElementById(
          "currentSelection"
        ).innerHTML = `üìÖ ${dayNames[currentDay]} - ${timeNames[currentTimeSlot]}`;
      }

      // Actualizar estad√≠sticas
      function updateStats() {
        const timeSlots = getTimeSlotsForPeriod(currentTimeSlot);
        let totalSlots = timeSlots.length * 6;
        let occupiedSlots = 0;
        let uniqueStudents = new Set();

        timeSlots.forEach((time) => {
          const category = getCategoryForTime(time);
          const slotData = scheduleData[currentDay]?.[category]?.[time];
          if (slotData && slotData.students) {
            slotData.students.forEach((student) => {
              if (student && student.name && student.name.trim()) {
                occupiedSlots++;
                uniqueStudents.add(student.name.trim().toLowerCase());
              }
            });
          }
        });
        
        // Ensure totalSlots is not zero to avoid NaN
        totalSlots = totalSlots > 0 ? totalSlots : 1; 

        const occupancyRate = ((occupiedSlots / totalSlots) * 100).toFixed(1);

        document.getElementById("statsSection").innerHTML = `
                <h3>üìä Estad√≠sticas del Turno Actual</h3>
                <span class="stat-item">üë• ${uniqueStudents.size} Alumnos √∫nicos</span>
                <span class="stat-item">üìã ${occupiedSlots}/${totalSlots} Turnos ocupados</span>
                <span class="stat-item">üìà ${occupancyRate}% Ocupaci√≥n</span>
            `;
      }

      // Actualizar asistencia
      function updateAttendance(day, category, time, bedIndex, isAttended) {
        if (scheduleData[day]?.[category]?.[time]?.students?.[bedIndex]) {
          scheduleData[day][category][time].students[bedIndex].attended = isAttended;
          saveScheduleToLocalStorage();
          updateStats(); // Update stats after attendance change
        } else {
          console.error("Error updating attendance: Student data not found.", {day, category, time, bedIndex});
        }
      }


      // Toggle edici√≥n
      function toggleEdit() {
        isEditing = !isEditing;
        originalData = JSON.parse(JSON.stringify(scheduleData));

        if (isEditing) {
          document.querySelector(".edit-btn.edit").style.display = "none";
          document.querySelector(".edit-btn.save").style.display =
            "inline-block";
          document.querySelector(".edit-btn.cancel").style.display =
            "inline-block";
        }

        createTable();
      }

      // Guardar cambios
      function saveChanges() {
        isEditing = false;
        document.querySelector(".edit-btn.edit").style.display = "inline-block";
        document.querySelector(".edit-btn.save").style.display = "none";
        document.querySelector(".edit-btn.cancel").style.display = "none";

        createTable();
        saveScheduleToLocalStorage();
        alert("‚úÖ Cambios guardados correctamente");
      }

      // Cancelar edici√≥n
      function cancelEdit() {
        isEditing = false;
        scheduleData = JSON.parse(JSON.stringify(originalData));

        document.querySelector(".edit-btn.edit").style.display = "inline-block";
        document.querySelector(".edit-btn.save").style.display = "none";
        document.querySelector(".edit-btn.cancel").style.display = "none";

        createTable();
      }

      // Limpiar horario actual
      function clearCurrentSchedule() {
        const dayName = currentDay.toUpperCase();
        let timeSlotName = "";
        if (currentTimeSlot === 'morning_afternoon_combined') {
            timeSlotName = "MA√ëANA Y TARDE (08:00-15:00)";
        } else if (currentTimeSlot === 'evening_combined') {
            timeSlotName = "TARDE Y NOCHE (16:00-21:00)";
        }

        if (
          confirm(
            `¬øEst√°s seguro de que quieres limpiar todos los horarios de ${dayName} - ${timeSlotName}?`
          )
        ) {
          const timeSlotsToClear = getTimeSlotsForPeriod(currentTimeSlot);
          timeSlotsToClear.forEach(slot => {
              const category = getCategoryForTime(slot);
              if (scheduleData[currentDay]?.[category]?.[slot]?.students) {
                  scheduleData[currentDay][category][slot].students = new Array(6).fill(null).map(() => ({ name: "", attended: false, notes: "" }));
                  // Decide if professor should be reset too
                  // scheduleData[currentDay][category][slot].professor = "Prof. Asignado";
                  // Optionally reset professor: scheduleData[currentDay][category][slot].professor = "Prof. Asignado";
              } else if (scheduleData[currentDay]?.[category]) {
                  scheduleData[currentDay][category][slot] = {
                      professor: "Prof. Asignado",
                      students: new Array(6).fill(null).map(() => ({ name: "", attended: false, notes: "" }))
                  };
              }
          });
          saveScheduleToLocalStorage();
          createTable();
        }
      }

      // Copiar horario
      function copySchedule() {
        const dataToCopy = {};
        const timeSlotsInView = getTimeSlotsForPeriod(currentTimeSlot);

        timeSlotsInView.forEach(slot => {
            const category = getCategoryForTime(slot);
            const slotData = scheduleData[currentDay]?.[category]?.[slot];
            if (slotData) {
                dataToCopy[slot] = JSON.parse(JSON.stringify(slotData));
            } else {
                dataToCopy[slot] = {
                    professor: "Prof. Asignado",
                    students: new Array(6).fill(null).map(() => ({ name: "", attended: false, notes: "" }))
                };
            }
        });

        copiedSchedule = {
          data: dataToCopy,
        };

        let timeSlotName = "";
        if (currentTimeSlot === 'morning_afternoon_combined') {
            timeSlotName = "MA√ëANA Y TARDE (08:00-15:00)";
        } else if (currentTimeSlot === 'evening_combined') {
            timeSlotName = "TARDE Y NOCHE (16:00-21:00)";
        }
        alert(
          `üìã Horario copiado: ${currentDay.toUpperCase()} - ${timeSlotName}`
        );
      }

      // Exportar datos
      function exportToJSON() {
        const dataStr = JSON.stringify(scheduleData, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "pilates_horarios_completo.json";
        link.click();
      }

      // Importar datos
      function importFromJSON() {
        const file = document.getElementById("importFile").files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              let importedData = JSON.parse(e.target.result);
              if (isOldFormat(importedData)) { // Check if imported data is old format
                importedData = transformScheduleData(importedData);
              }
              scheduleData = importedData;
              saveScheduleToLocalStorage();
              createTable();
              alert("‚úÖ Datos importados correctamente");
            } catch (error) {
              alert("‚ùå Error al importar: archivo inv√°lido");
            }
          };
          reader.readAsText(file);
        }
      }

      // Imprimir horario
      function printSchedule() {
        window.print();
      }

      // Modal functions
      function openStudentModal(day, category, time, bedIndex) {
        const slotData = scheduleData[day]?.[category]?.[time];
        if (!slotData || !slotData.students || !slotData.students[bedIndex]) return;

        const student = slotData.students[bedIndex];
        const professor = slotData.professor || "No asignado";

        if (!student || !student.name) return; // Don't open for empty slots

        currentModalInfo = { day, category, time, bedIndex };

        document.getElementById("modalStudentName").textContent = student.name;
        document.getElementById("modalProfessorName").textContent = professor;
        document.getElementById("modalAttendanceStatus").textContent = student.attended ? "Presente" : "Ausente";
        document.getElementById("modalStudentNotes").value = student.notes || "";

        document.getElementById("studentModal").style.display = "block";
      }

      function closeStudentModal() {
        document.getElementById("studentModal").style.display = "none";
        currentModalInfo = {};
      }

      function saveStudentNotes() {
        const { day, category, time, bedIndex } = currentModalInfo;
        if (day && scheduleData[day]?.[category]?.[time]?.students?.[bedIndex]) {
          scheduleData[day][category][time].students[bedIndex].notes = document.getElementById("modalStudentNotes").value;
          saveScheduleToLocalStorage();
          alert("Notas guardadas.");
          closeStudentModal();
        }
      }

      // Theme toggle functions
      function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('pilatesTheme', 'dark');
        } else {
            localStorage.setItem('pilatesTheme', 'light');
        }
      }

      function loadThemePreference() {
        const savedTheme = localStorage.getItem('pilatesTheme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }
      }

      // Close modal if user clicks outside of it
      window.onclick = function(event) {
        const modal = document.getElementById("studentModal");
        if (event.target == modal) {
          closeStudentModal();
        }
      }

      // Inicializar aplicaci√≥n
      document.addEventListener("DOMContentLoaded", function () {
        loadScheduleFromLocalStorage();
        if (isOldFormat(scheduleData)) { // Check initial or loaded data
            console.log("Transformando datos a nuevo formato...");
            scheduleData = transformScheduleData(scheduleData);
            saveScheduleToLocalStorage(); // Save transformed data immediately
        }
        loadThemePreference();
        updateCurrentSelection();
        createTable();
      });

    </script>
  </body>
</html>
